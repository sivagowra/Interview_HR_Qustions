<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DevSecOps CI/CD Setup Documentation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background: #f9f9f9;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        pre {
            background: #1e1e1e;
            color: #dcdcdc;
            padding: 15px;
            overflow-x: auto;
            border-radius: 5px;
        }
        ul {
            background: #ffffff;
            padding: 15px;
            border-radius: 5px;
        }
        section {
            margin-bottom: 30px;
            background: #ffffff;
            padding: 20px;
            border-radius: 6px;
        }
    </style>
</head>
<body>

<h1>DevSecOps CI/CD Pipeline & Kubernetes Setup</h1>

<section>
    <h2>1. EC2 Instance Setup</h2>
    <ul>
        <li>Launch EC2 instance with <strong>t2.large</strong></li>
        <li>Install Jenkins</li>
        <li>Install Git</li>
        <li>Install Trivy</li>
    </ul>

    <h3>Trivy Installation Steps</h3>
    <pre>
wget https://github.com/aquasecurity/trivy/releases/download/v0.18.3/trivy_0.18.3_Linux-64bit.tar.gz
tar zxvf trivy_0.18.3_Linux-64bit.tar.gz
sudo mv trivy /usr/local/bin/

vim ~/.bashrc
export PATH=$PATH:/usr/local/bin/
source ~/.bashrc
    </pre>
</section>

<section>
    <h2>2. Docker & SonarQube Setup</h2>
    <ul>
        <li>Install Docker</li>
        <li>Give permission to <code>/var/run/docker.sock</code></li>
        <li>Create SonarQube container</li>
    </ul>

    <pre>
docker run -d --name sonar -p 9000:9000 sonarqube:lts-community
    </pre>

    <h3>Install Jenkins Plugins</h3>
    <ul>
        <li>Eclipse Temurin Installer</li>
        <li>SonarQube Scanner</li>
        <li>NodeJS Plugin</li>
        <li>OWASP Dependency Check</li>
        <li>Docker Pipeline Plugin</li>
    </ul>
</section>

<section>
    <h2>3. Jenkins Tool Configuration</h2>
    <ul>
        <li>JDK Name: <strong>jdk17</strong> (17.0.8.1+1)</li>
        <li>Node Name: <strong>node16</strong> (16.2.0)</li>
        <li>Sonar Scanner Name: <strong>sonar-scanner</strong> (5.0.1.3006)</li>
        <li>Dependency Check Tool: <strong>Dp-Check</strong> (6.5.1)</li>
    </ul>

    <h3>SonarQube Configuration</h3>
    <ul>
        <li>Create Sonar user & generate token</li>
        <li>Add token to Jenkins credentials</li>
        <li>Configure Sonar Server in Jenkins System</li>
        <li>Add Quality Gate</li>
        <li>Configure Webhooks</li>
    </ul>
</section>

<section>
    <h2>4. Jenkins Pipeline</h2>
    <pre>
pipeline {
    agent any
    tools {
        jdk 'jdk17'
        nodejs 'node16'
    }
    environment {
        SCANNER_HOME=tool 'mysonar'
    }
    stages {
        stage ("Clean") {
            steps { cleanWs() }
        }
        stage ("Code") {
            steps {
                git branch: 'main',
                url: 'https://github.com/devops0014/Zomato-Repo.git'
            }
        }
        stage("Sonarqube Analysis") {
            steps {
                withSonarQubeEnv('mysonar') {
                    sh '''$SCANNER_HOME/bin/sonar-scanner
                    -Dsonar.projectName=zomato
                    -Dsonar.projectKey=zomato'''
                }
            }
        }
        stage ("Quality Gates") {
            steps {
                waitForQualityGate abortPipeline: false,
                credentialsId: 'sonar-token'
            }
        }
        stage ("Install dependencies") {
            steps { sh 'npm install' }
        }
        stage ("OWASP") {
            steps {
                dependencyCheck additionalArguments:
                '--scan ./ --disableYarnAudit --disableNodeAudit',
                odcInstallation: 'Dp-Check'
                dependencyCheckPublisher
                pattern: '**/dependency-check-report.xml'
            }
        }
        stage ("Trivy scan") {
            steps { sh 'trivy fs . > trivyfs.txt' }
        }
        stage ("Docker Build") {
            steps { sh 'docker build -t image1 .' }
        }
        stage("Docker Push") {
            steps {
                withDockerRegistry(credentialsId: 'docker-password') {
                    sh 'docker tag image1 shaikmustafa/loki:mydockerimage'
                    sh 'docker push shaikmustafa/loki:mydockerimage'
                }
            }
        }
        stage ("Image Scan") {
            steps {
                sh 'trivy image shaikmustafa/loki:mydockerimage'
            }
        }
        stage ("Deploy") {
            steps {
                sh 'docker run -d --name zomato -p 3000:3000 shaikmustafa/loki:mydockerimage'
            }
        }
    }
}
    </pre>
</section>

<section>
    <h2>5. Kubernetes & Argo CD Setup</h2>
    <h3>Create Cluster Using KOPS</h3>

    <h3>Install Helm</h3>
    <pre>
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
chmod 700 get_helm.sh
./get_helm.sh
helm version
    </pre>

    <h3>Install Argo CD</h3>
    <pre>
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
kubectl get all -n argocd
    </pre>

    <h3>Expose Argo CD</h3>
    <pre>
kubectl patch svc argocd-server -n argocd -p '{"spec":{"type":"LoadBalancer"}}'
yum install jq -y
kubectl get svc argocd-server -n argocd -o json |
jq -r .status.loadBalancer.ingress[0].hostname
    </pre>

    <h3>Get Argo CD Password</h3>
    <pre>
kubectl -n argocd get secret argocd-initial-admin-secret \
-o jsonpath="{.data.password}" | base64 -d
    </pre>
</section>

<section>
    <h2>6. Monitoring: Loki & Promtail</h2>
    <pre>
mkdir grafana_configs
cd grafana_configs

wget https://raw.githubusercontent.com/grafana/loki/v2.8.0/cmd/loki/loki-local-config.yaml \
-O loki-config.yaml

wget https://raw.githubusercontent.com/grafana/loki/v2.8.0/clients/cmd/promtail/promtail-docker-config.yaml \
-O promtail-config.yaml

docker run -d --name loki \
-v $(pwd):/mnt/config -p 3100:3100 \
grafana/loki:2.8.0 \
--config.file=/mnt/config/loki-config.yaml

docker run -d --name promtail \
-v $(pwd):/mnt/config \
-v /var/log:/var/log \
--link loki \
grafana/promtail:2.8.0 \
--config.file=/mnt/config/promtail-config.yaml
    </pre>
</section>

</body>
</html>
